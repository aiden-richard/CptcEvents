@model CptcEvents.Models.GroupEventsViewModel

@* Group events page with calendar and upcoming event cards *@

<div class="page-shell">
    <div class="d-flex justify-content-between align-items-start flex-wrap gap-2">
        <div>
            <p class="text-muted small mb-1">Group Details</p>
            <h2 class="mb-0">@Model.Group.Name</h2>
        </div>
        <div class="d-flex justify-content-end flex-wrap gap-2 ms-auto align-self-end">
            <a class="btn btn-outline-secondary" href="@Url.Action("Index", "Groups")">Back to My Groups</a>
            @if (Model.UserIsModerator)
            {
            <a class="btn btn-outline-primary" href="@Url.Action("ManageGroup", "Groups", new { groupId = Model.Group.Id })">Manage Group</a>
            }
        </div>
    </div>

    <div class="card shadow-soft calendar-card">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-3">
                <div>
                    <h5 class="mb-1">Calendar</h5>
                    <p class="text-muted small mb-0">View all scheduled events for this group.</p>
                </div>
                <div>
                    <a class="btn btn-outline-primary" href="@Url.Action("ManageEvents", "Groups", new { groupId = Model.Group.Id })">Manage events</a>
                    <a class="btn btn-primary" href="@Url.Action("Create", "Events", new { groupId = Model.Group.Id })">Create event</a>
                </div>
            </div>
            @await Component.InvokeAsync("Calendar", new { 
                eventsUrl = Url.Action("GetGroupEvents", "Events", new { groupId = Model.Group.Id }), 
                elementId = "group-calendar-" + Model.Group.Id,
                initialView = "dayGridMonth"
            })
        </div>
    </div>

    <div class="card shadow-soft">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-3">
                <h3 class="mb-0">Upcoming Events</h3>
            </div>
            @if (Model.UpcomingEvents.Any())
            {
                var today = DateOnly.FromDateTime(DateTime.UtcNow);

                <div class="d-flex flex-column gap-1">
                    @foreach (var evt in Model.UpcomingEvents)
                    {
                        var daysUntil = evt.DateOfEvent.DayNumber - today.DayNumber;
                        var dateHint = daysUntil switch
                        {
                            0 => "Today",
                            1 => "Tomorrow",
                            <= 7 => $"In {daysUntil} days",
                            _ => (string?)null
                        };

                        <div class="card w-100">
                            <div class="card-body p-2">
                                <div class="d-flex flex-column flex-md-row align-items-start justify-content-between gap-2">
                                    <div class="d-flex align-items-baseline gap-2 flex-grow-1">
                                        <div class="flex-shrink-0 text-center" style="min-width: 4.5rem;">
                                            <div class="fw-semibold small">@evt.DateOfEvent.ToString("MMM d")</div>
                                            @if (dateHint != null)
                                            {
                                                <div class="text-muted" style="font-size: 0.7rem;">@dateHint</div>
                                            }
                                        </div>
                                        <div>
                                            <h6 class="mb-0">
                                                <a asp-controller="Events" asp-action="Details" asp-route-eventId="@evt.Id" class="text-decoration-none text-body">@evt.Title</a>
                                            </h6>
                                            @if (!evt.IsPublic)
                                            {
                                                <span class="badge rounded-pill text-bg-secondary" style="font-size: 0.65rem;">Private</span>
                                            }
                                        </div>
                                    </div>
                                    <div class="flex-shrink-0 text-md-end">
                                        @if (evt.IsAllDay)
                                        {
                                            <span class="text-muted small">All day</span>
                                        }
                                        else
                                        {
                                            <span class="text-muted small">@evt.StartTime.ToString("h:mm tt") &ndash; @evt.EndTime.ToString("h:mm tt")</span>
                                        }
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            }
            else
            {
                <p class="text-muted mb-0">No upcoming events.</p>
            }
        </div>
    </div>
</div>