@model CptcEvents.Models.EventDetailsViewModel
@using CptcEvents.Models
@{
    ViewData["Title"] = Model.Title;

    var timeLabel = Model.IsAllDay
        ? "All Day"
        : $"{Model.StartTime:h:mm tt} - {Model.EndTime:h:mm tt}";

    var isStaffOrAdmin = User.IsInRole("Staff") || User.IsInRole("Admin");

    // Build EventFormViewModel from EventDetailsViewModel for use in the shared form partial
    var editModel = new EventFormViewModel
    {
        Id = Model.Id,
        Title = Model.Title,
        Description = Model.Description,
        GroupId = Model.GroupId,
        GroupName = Model.GroupName,
        IsPublic = Model.IsPublic,
        IsApprovedPublic = Model.IsApprovedPublic,
        IsDeniedPublic = Model.IsDeniedPublic,
        IsAllDay = Model.IsAllDay,
        DateOfEvent = Model.DateOfEvent,
        StartTime = Model.StartTime,
        EndTime = Model.EndTime,
        Url = Model.Url,
        BannerImageUrl = Model.BannerImageUrl
    };
}

@* Event detail page with inline editing support *@

<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-8">

            @if (TempData["Error"] != null)
            {
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    @TempData["Error"]
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            }

            <div class="card shadow-sm" id="eventCard">
                @* Banner image *@
                <div id="bannerView">
                    @if (!string.IsNullOrEmpty(Model.BannerImageUrl))
                    {
                        <img src="@Model.BannerImageUrl" class="card-img-top" alt="Event banner" style="max-height: 300px; object-fit: cover;" />
                    }
                </div>

                <div class="card-body">
                    @* === VIEW MODE === *@
                    <div id="viewMode">
                        <h2 class="card-title mb-3" id="viewTitle">@Model.Title</h2>

                        @if (!string.IsNullOrEmpty(Model.Description))
                        {
                            <div class="mb-3" id="viewDescription">
                                @Html.Raw(Model.Description)
                            </div>
                            <hr />
                        }

                        <dl class="row mb-0">
                            <dt class="col-sm-4">Group</dt>
                            <dd class="col-sm-8">
                                @if (Model.IsCurrentUserMember)
                                {
                                    <a asp-controller="Groups" asp-action="Events" asp-route-groupId="@Model.GroupId">@Model.GroupName</a>
                                }
                                else
                                {
                                    @Model.GroupName
                                }
                            </dd>

                            <dt class="col-sm-4">Date</dt>
                            <dd class="col-sm-8">@Model.DateOfEvent.ToString("dddd, MMMM d, yyyy")</dd>

                            <dt class="col-sm-4">Time</dt>
                            <dd class="col-sm-8">@timeLabel</dd>

                            <dt class="col-sm-4">Visibility</dt>
                            <dd class="col-sm-8">
                                @if (Model.IsPublic)
                                {
                                    <span class="badge bg-success">Public</span>
                                    @if (Model.IsApprovedPublic)
                                    {
                                        <span class="badge bg-success">Approved</span>
                                    }
                                    else if (Model.IsDeniedPublic)
                                    {
                                        <span class="badge bg-danger">Denied</span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-warning text-dark">Pending</span>
                                    }
                                }
                                else
                                {
                                    <span class="badge bg-secondary">Private</span>
                                }
                            </dd>

                            @if (!string.IsNullOrWhiteSpace(Model.Url))
                            {
                                <dt class="col-sm-4">URL</dt>
                                <dd class="col-sm-8">
                                    <a href="@Model.Url" target="_blank" rel="noopener noreferrer">@Model.Url</a>
                                </dd>
                            }
                        </dl>
                    </div>

                    @* === EDIT MODE (hidden by default) === *@
                    @if (Model.CanEdit)
                    {
                        <form id="editMode" asp-action="Edit" asp-route-eventId="@Model.Id" method="post" enctype="multipart/form-data" style="display: none;">
                            @Html.AntiForgeryToken()
                            <input type="hidden" name="Id" value="@Model.Id" />
                            <input type="hidden" name="GroupId" value="@Model.GroupId" />
                            <input type="hidden" name="IsModerator" value="true" />

                            <partial name="_EventFormFields" model="editModel" />

                            @* Danger zone *@
                            <hr class="mt-4" />
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="text-muted">Danger Zone</span>
                                <a asp-action="Delete" asp-route-eventId="@Model.Id" class="btn btn-outline-danger btn-sm">Delete Event</a>
                            </div>
                        </form>
                    }
                </div>

                @* Card footer - toggles between view and edit mode buttons *@
                <div class="card-footer d-flex justify-content-between" id="viewFooter">
                    <a asp-action="Index" class="btn btn-secondary">Back to Events</a>
                    @if (Model.CanEdit)
                    {
                        <button type="button" class="btn btn-primary" id="editBtn">Edit Event</button>
                    }
                </div>

                @* Edit mode footer (hidden by default) *@
                @if (Model.CanEdit)
                {
                    <div class="card-footer d-flex justify-content-between" id="editFooter" style="display: none !important;">
                        <button type="button" class="btn btn-secondary" id="cancelEditBtn">Cancel</button>
                        <button type="submit" form="editMode" class="btn btn-primary" id="saveBtn">Save Changes</button>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @if (Model.CanEdit)
    {
        <link href="https://cdn.jsdelivr.net/npm/quill@2/dist/quill.snow.css" rel="stylesheet" />
        <script src="https://cdn.jsdelivr.net/npm/quill@2/dist/quill.js"></script>
        <script>
            (function () {
                var editBtn = document.getElementById('editBtn');
                var cancelEditBtn = document.getElementById('cancelEditBtn');
                var viewMode = document.getElementById('viewMode');
                var editMode = document.getElementById('editMode');
                var viewFooter = document.getElementById('viewFooter');
                var bannerView = document.getElementById('bannerView');
                var quillEditor = null;

                // All-day checkbox toggle for time fields
                var isAllDayCheckbox = document.getElementById('editIsAllDay');
                var timeFieldWrappers = document.querySelectorAll('.time-fields');

                function updateTimeFields() {
                    var hidden = isAllDayCheckbox && isAllDayCheckbox.checked;
                    timeFieldWrappers.forEach(function (w) {
                        var inputs = w.querySelectorAll('input');
                        inputs.forEach(function (i) { i.disabled = hidden; });
                        w.style.display = hidden ? 'none' : '';
                    });
                }

                if (isAllDayCheckbox) {
                    isAllDayCheckbox.addEventListener('change', updateTimeFields);
                }

                function enterEditMode() {
                    viewMode.style.display = 'none';
                    viewFooter.style.setProperty('display', 'none', 'important');
                    bannerView.style.display = 'none';
                    editMode.style.display = 'block';
                    var editFooter = document.getElementById('editFooter');
                    if (editFooter) {
                        editFooter.style.setProperty('display', 'flex', 'important');
                    }

                    updateTimeFields();

                    // Initialize Quill editor if not already done
                    if (!quillEditor) {
                        quillEditor = new Quill('#quill-editor', {
                            theme: 'snow',
                            modules: {
                                toolbar: [
                                    [{ 'header': [1, 2, 3, false] }],
                                    ['bold', 'italic', 'underline', 'strike'],
                                    [{ 'list': 'ordered' }, { 'list': 'bullet' }],
                                    ['link', 'blockquote', 'code-block'],
                                    ['clean']
                                ]
                            }
                        });

                        // Load existing description HTML into Quill
                        var descriptionHidden = document.getElementById('descriptionHidden');
                        if (descriptionHidden.value) {
                            quillEditor.root.innerHTML = descriptionHidden.value;
                        }
                    }
                }

                function exitEditMode() {
                    editMode.style.display = 'none';
                    viewMode.style.display = 'block';
                    viewFooter.style.setProperty('display', 'flex', 'important');
                    bannerView.style.display = 'block';
                    var editFooter = document.getElementById('editFooter');
                    if (editFooter) {
                        editFooter.style.setProperty('display', 'none', 'important');
                    }
                }

                if (editBtn) {
                    editBtn.addEventListener('click', enterEditMode);
                }

                if (cancelEditBtn) {
                    cancelEditBtn.addEventListener('click', exitEditMode);
                }

                // Copy Quill content to hidden textarea before form submission
                if (editMode) {
                    editMode.addEventListener('submit', function () {
                        if (quillEditor) {
                            var html = quillEditor.root.innerHTML;
                            // Quill sets empty content as <p><br></p>
                            if (html === '<p><br></p>') {
                                html = '';
                            }
                            document.getElementById('descriptionHidden').value = html;
                        }
                    });
                }
            })();
        </script>
    }
}
