@model CptcEvents.Models.EventFormViewModel
@{
    ViewData["Title"] = "Create Event";
}

@* Form to create a new event for a selected group *@

<div class="page-shell">
    @if (TempData["Error"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            @TempData["Error"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    <div>
        <p class="text-muted small mb-1 text-uppercase fw-semibold" style="letter-spacing:0.06em;">Events</p>
        <h2 class="mb-0">Create Event</h2>
    </div>

    <div class="card">
        <div class="card-body">
            <form asp-action="Create" method="post" enctype="multipart/form-data">
                @Html.AntiForgeryToken()
                <div asp-validation-summary="ModelOnly" class="text-danger" role="alert"></div>

                <partial name="_EventFormFields" model="Model" />

                <div class="d-flex justify-content-between mt-4">
                    <a asp-action="Index" class="btn btn-outline-secondary">Cancel</a>
                    <button type="submit" class="btn btn-primary">Create Event</button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <link href="https://cdn.jsdelivr.net/npm/quill@2/dist/quill.snow.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/quill@2/dist/quill.js"></script>
    <script>
        (function () {
            // Initialize Quill editor
            var quillEditor = new Quill('#quill-editor', {
                theme: 'snow',
                modules: {
                    toolbar: [
                        [{ 'header': [1, 2, 3, false] }],
                        ['bold', 'italic', 'underline', 'strike'],
                        [{ 'list': 'ordered' }, { 'list': 'bullet' }],
                        ['link', 'blockquote', 'code-block'],
                        ['clean']
                    ]
                }
            });

            // Copy Quill content to hidden textarea before form submission
            var form = document.querySelector('form');
            if (form) {
                form.addEventListener('submit', function () {
                    var html = quillEditor.root.innerHTML;
                    // Quill sets empty content as <p><br></p>
                    if (html === '<p><br></p>') {
                        html = '';
                    }
                    document.querySelector('textarea[asp-for="Description"]').value = html;
                });
            }

            // All-day checkbox toggle for time fields
            var isAllDay = document.getElementById('IsAllDay');
            var timeFieldWrappers = document.querySelectorAll('.time-fields');

            function updateTimeFields() {
                var hidden = isAllDay && isAllDay.checked;
                timeFieldWrappers.forEach(function (w) {
                    var inputs = w.querySelectorAll('input');
                    inputs.forEach(function (i) { i.disabled = hidden; });
                    w.style.display = hidden ? 'none' : '';
                });
            }

            if (isAllDay) {
                isAllDay.addEventListener('change', updateTimeFields);
                updateTimeFields();
            }
        })();
    </script>
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
}