@using System.Text.Json
@model CptcEvents.Models.CalendarViewModel

@* Render container and script bootstrapping for FullCalendar component *@

<div id="@Model.ElementId"
     data-events-url="@Model.EventsUrl"
     data-initial-view="@Model.InitialView">
</div>

<!-- Event Details Modal -->
<div class="modal fade" id="eventModal" tabindex="-1" aria-labelledby="eventModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="eventModalLabel">Event Details</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="eventModalBody">
                <div class="text-center">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <a id="eventModalViewDetails" class="btn btn-outline-primary" href="#" style="display: none;">View Details</a>
                <a id="eventModalViewGroup" class="btn btn-primary" href="#" style="display: none;">View Group</a>
            </div>
        </div>
    </div>
</div>

<script>
    (function () {
        var CDN_SRC = 'https://cdn.jsdelivr.net/npm/fullcalendar@6.1.19/index.global.min.js';
        var CDN_SCRIPT_ID = 'fullcalendar-cdn-script';
        var elementId = @Html.Raw(JsonSerializer.Serialize(Model.ElementId));

            // Ensure the FullCalendar script is loaded once (shared by all instances) before continuing.
            function ensureFullCalendarLoaded(onLoaded) {
                if (window.FullCalendar) {
                    onLoaded();
                    return;
                }

                var script = document.getElementById(CDN_SCRIPT_ID);
                if (!script) {
                    script = document.createElement('script');
                    script.id = CDN_SCRIPT_ID;
                    script.src = CDN_SRC;
                    script.async = true;
                    script.addEventListener('load', onLoaded);
                    script.addEventListener('error', function () {
                        console.error('Failed to load FullCalendar from CDN.');
                    });
                    document.head.appendChild(script);
                    return;
                }

                script.addEventListener('load', onLoaded);
            }

            // Fetch events JSON from the provided endpoint and hand results to FullCalendar callbacks.
            function fetchEvents(eventsUrl, success, failure) {
                fetch(eventsUrl)
                    .then(function (response) {
                        if (!response.ok) {
                            throw new Error('Network response was not ok: ' + response.status);
                        }
                        return response.json();
                    })
                    .then(function (eventsArray) {
                        if (Array.isArray(eventsArray)) {
                            // Apply background color from the DTO
                            eventsArray.forEach(event => {
                                if (event.backgroundColor) {
                                    event.backgroundColor = event.backgroundColor;
                                    event.borderColor = event.backgroundColor;
                                }
                            });
                            success(eventsArray);
                        } else {
                            success([]);
                        }
                    })
                    .catch(function (error) {
                        console.error('Error fetching or parsing events:', error);
                        if (typeof failure === 'function') {
                            failure(error);
                        }
                    });
            }

            // Create and render the calendar instance on the target element with provided options.
            function initCalendar(el, options) {
                if (!el) {
                    return;
                }

                var initialView = options.initialView || 'dayGridMonth';
                var eventsUrl = options.eventsUrl;
                if (!eventsUrl) {
                    console.error('Calendar requires an eventsUrl.');
                    return;
                }

                ensureFullCalendarLoaded(function () {
                    if (!window.FullCalendar) {
                        console.error('FullCalendar failed to load.');
                        return;
                    }

                    var calendar = new FullCalendar.Calendar(el, {
                        initialView: initialView,
                        events: function (info, successCallback, failureCallback) {
                            fetchEvents(eventsUrl, successCallback, failureCallback);
                        },
                        eventClick: function(info) {
                            var eventId = info.event.id;
                            if (!eventId) {
                                console.warn('Event ID not found in event:', info.event);
                                return;
                            }
                            openEventModal(eventId);
                        },
                        eventMouseEnter: function(info) {
                            // Add visual effect on hover - increase opacity/brightness
                            info.el.style.opacity = '0.8';
                            info.el.style.boxShadow = '0 2px 8px rgba(0, 0, 0, 0.3)';
                            info.el.style.transform = 'scale(1.02)';
                        },
                        eventMouseLeave: function(info) {
                            // Reset on mouse leave
                            info.el.style.opacity = '1';
                            info.el.style.boxShadow = 'none';
                            info.el.style.transform = 'scale(1)';
                        },
                    });

                    calendar.render();
                });
            }

            // Read data-* attributes from the element to build options, then initialize the calendar.
            function initFromElement(elementOrId) {
                var el = typeof elementOrId === 'string' ? document.getElementById(elementOrId) : elementOrId;
                if (!el) {
                    console.warn('Calendar element not found for id:', elementOrId);
                    return;
                }

                var options = {
                    initialView: el.dataset.initialView || 'dayGridMonth',
                    eventsUrl: el.dataset.eventsUrl || ''
                };

                initCalendar(el, options);
            }

            var el = document.getElementById(elementId);
            if (!el) {
                console.warn('Calendar element not found for id:', elementId);
                return;
            }

            // Prevent duplicate initialization on the same element.
            if (el.dataset.calendarInitialized === 'true') {
                return;
            }

            el.dataset.calendarInitialized = 'true';

            // Kick off calendar setup using the element's data attributes.
            initFromElement(el);
        })();

        // Function to open event modal and fetch details
        function openEventModal(eventId) {
            var modal = new bootstrap.Modal(document.getElementById('eventModal'));
            var modalBody = document.getElementById('eventModalBody');
            var modalTitle = document.getElementById('eventModalLabel');
            var viewGroupBtn = document.getElementById('eventModalViewGroup');
            var viewDetailsBtn = document.getElementById('eventModalViewDetails');

            // Reset modal content
            modalTitle.textContent = 'Event Details';
            modalBody.innerHTML = '<div class="text-center"><div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div></div>';
            viewGroupBtn.style.display = 'none';
            viewDetailsBtn.style.display = 'none';

            // Show modal
            modal.show();

            // Fetch event details (with Accept header for content negotiation)
            fetch('/Events/Details/' + eventId, {
                headers: { 'Accept': 'application/json' }
            })
                .then(function (response) {
                    if (!response.ok) {
                        throw new Error('Failed to fetch event details');
                    }
                    return response.json();
                })
                .then(function (event) {
                    // Update modal title
                    modalTitle.textContent = event.title || 'Event Details';

                    // Format date and time
                    var eventDate = new Date(event.dateOfEvent + 'T00:00:00');
                    var dateString = eventDate.toLocaleDateString('en-US', {
                        weekday: 'long',
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    });

                    var timeString = '';
                    if (!event.isAllDay && event.startTime && event.endTime) {
                        var startTime = new Date('2000-01-01T' + event.startTime + ':00');
                        var endTime = new Date('2000-01-01T' + event.endTime + ':00');
                        timeString = startTime.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' }) + 
                                   ' - ' + endTime.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
                    } else {
                        timeString = 'All Day';
                    }

                    // Build modal content
                    var modalContent = '<div class="row g-3">';
                    
                    if (event.groupName) {
                        modalContent += '<div class="col-12"><div class="d-flex align-items-center gap-2"><strong>Group:</strong> <span class="badge bg-primary">' + escapeHtml(event.groupName) + '</span></div></div>';
                    }
                    
                    modalContent += '<div class="col-12"><div><strong>Date:</strong> ' + dateString + '</div></div>';
                    modalContent += '<div class="col-12"><div><strong>Time:</strong> ' + timeString + '</div></div>';

                    if (event.url && event.url.trim()) {
                        modalContent += '<div class="col-12"><div><strong>URL:</strong> <a href="' + escapeHtml(event.url) + '" target="_blank" rel="noopener">' + escapeHtml(event.url) + '</a></div></div>';
                    }
                    
                    if (!event.isPublic) {
                        modalContent += '<div class="col-12"><span class="badge bg-secondary">Private Event</span></div>';
                    }
                    
                    modalContent += '</div>';

                    modalBody.innerHTML = modalContent;

                    // Setup View Details button (always shown)
                    viewDetailsBtn.href = '/Events/Details/' + eventId;
                    viewDetailsBtn.style.display = 'inline-block';

                    // Setup View Group button - only show if user is a member of the group
                    if (event.groupId && event.isCurrentUserMember) {
                        viewGroupBtn.href = '/Groups/' + event.groupId + '/Events';
                        viewGroupBtn.style.display = 'inline-block';
                    }
                })
                .catch(function (error) {
                    console.error('Error fetching event details:', error);
                    modalBody.innerHTML = '<div class="alert alert-danger" role="alert">Failed to load event details. Please try again.</div>';
                });
        }

        // Helper function to escape HTML
        function escapeHtml(text) {
            var div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

</script>

<style>
    /* Change cursor to pointer on event hover in FullCalendar */
    #@(Model.ElementId) .fc-event {
        cursor: pointer;
        transition: opacity 0.2s ease, box-shadow 0.2s ease, transform 0.2s ease;
    }
</style>