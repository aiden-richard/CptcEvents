name: .NET

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout main branch
      - name: Checkout main
        uses: actions/checkout@v4

      # Step 2: Install .NET 10 Preview manually
      - name: Install .NET 10 Preview SDK
        run: |
          wget https://dot.net/v1/dotnet-install.sh -O dotnet-install.sh
          chmod +x dotnet-install.sh
          ./dotnet-install.sh --version 10.0.100-rc.2.25502.107
          echo "DOTNET_ROOT=$HOME/.dotnet" >> $GITHUB_ENV
          echo "$HOME/.dotnet:$HOME/.dotnet/tools" >> $GITHUB_PATH

      # Step 3: Verify .NET version
      - name: Verify .NET version
        run: dotnet --info

      # Step 4: Restore dependencies
      - name: Restore dependencies
        run: dotnet restore

      # Step 5: Build
      - name: Build
        run: dotnet build --configuration Release --no-restore

      # Step 6: Login to Azure
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      # Step 7: Login to ACR
      - name: Login to Azure Container Registry
        run: az acr login --name cptcevents

      # Step 8: Build and Push Docker Image
      - name: Build and Push Docker Image
        working-directory: ./CptcEvents
        run: |
          docker build -t cptcevents-fbh7bqh0f6a6hpgt.azurecr.io/cptcevents:${{ github.sha }} \
                       -t cptcevents-fbh7bqh0f6a6hpgt.azurecr.io/cptcevents:latest .
          docker push cptcevents-fbh7bqh0f6a6hpgt.azurecr.io/cptcevents:${{ github.sha }}
          docker push cptcevents-fbh7bqh0f6a6hpgt.azurecr.io/cptcevents:latest

      # Step 9: Deploy to Azure Container Instances
      - name: Deploy to ACI
        run: |
          # Delete existing container if it exists
          az container delete \
            --resource-group CptcEventsResourceGroup \
            --name cptcevents-container \
            --yes || true
          
          # Create new container with latest image
          az container create \
            --resource-group CptcEventsResourceGroup \
            --name cptcevents-container \
            --image cptcevents-fbh7bqh0f6a6hpgt.azurecr.io/cptcevents:latest \
            --cpu 1 --memory 1.5 \
            --registry-login-server cptcevents-fbh7bqh0f6a6hpgt.azurecr.io \
            --registry-username cptcevents \
            --registry-password ${{ secrets.ACR_PASSWORD }} \
            --ip-address Public \
            --dns-name-label cptcevents \
            --ports 8080 \
            --environment-variables \
              ASPNETCORE_ENVIRONMENT=Production \
            --secure-environment-variables \
              ConnectionStrings__DefaultConnection="${{ secrets.SQL_CONNECTION_STRING }}" \
              SendGrid__ApiKey="${{ secrets.SENDGRID_API_KEY }}" \
              AdminUser__Password="${{ secrets.ADMIN_PASSWORD }}"
